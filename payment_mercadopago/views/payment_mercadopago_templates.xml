<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="mercadopago_form">
        <input type="hidden" name="data_set" t-att-data-action-url="tx_url" data-remove-me=""/>
        <input name="cmd" t-att-value="cmd" type="hidden"/>
    </template>

    <!-- <template id="payment_mercadopago_redirect" name="Payment MercadoPago">
        <script type="text/javascript">
            window.location.href = '<t t-esc="return_url"/>';
        </script>
    </template> -->

    <template id="mercadopago_s2s_form">
        <input type="hidden" name="data_set" value="/payment/mercadopago/s2s/create_json_3ds"/>
        <input type="hidden" name="acquirer_id" t-att-value="id"/>
        <input t-if="return_url" type="hidden" name="return_url" t-att-value="return_url"/>
        <input t-if="partner_id" type="hidden" name="partner_id" t-att-value="partner_id"/>
        <input type="hidden" name="mercadopago_publishable_key" t-att-value="acq.sudo().mercadopago_publishable_key"/>
        <div t-attf-class="row mt6 #{'' if bootstrap_formatting else 'o_card_brand_detail'}">
        <t t-set="order" t-value="order or sale_order"/>
        <t t-set="amount" t-value="order.amount_total if order else amount"/>

            <!-- Email -->
            <div t-att-class="'form-group col-lg-5' if bootstrap_formatting else 'form-group'">
                <t t-set="email" t-value="order.partner_id.email if order and request.website.is_public_user() else request.env.user.email"/>
                <input id="email" placeholder="email" name="email" t-att-value="email" t-att-class="'o_hidden' if email else 'form-control'"></input>
            </div>

            <!-- Card -->
            <div t-att-class="'form-group col-lg-10' if bootstrap_formatting else 'form-group'">
                <input type="tel" id="cc_number" data-checkout="cardNumber"
                    placeholder="XXXX - XXXX - XXXX - XXXX"
                    onselectstart="return false"
                    oncopy="return false" oncut="return false"
                    ondrag="return false" ondrop="return false" autocomplete="off"
                    class="form-control"
                    data-is-required="true">
                </input>
                <div class="card_placeholder"></div>
                <div class="visa"></div>
                <input type="hidden" name="cc_brand" value=""/>
            </div>

            <div t-att-class="'form-group col-lg-3' if bootstrap_formatting else 'form-group'">
                <input type="text" id="cardExpirationMonth" data-checkout="cardExpirationMonth"
                    placeholder="MM"
                    maxlength="2"
                    onselectstart="return false" onpaste="return false"
                    oncopy="return false" oncut="return false"
                    ondrag="return false" ondrop="return false" autocomplete="off"
                    class="form-control">
                </input>
            </div>

            <div t-att-class="'form-group col-lg-3' if bootstrap_formatting else 'form-group'">
                <input type="text" id="cardExpirationYear" data-checkout="cardExpirationYear"
                    placeholder="YY"
                    maxlength="2"
                    onselectstart="return false" onpaste="return false"
                    oncopy="return false" oncut="return false"
                    ondrag="return false" ondrop="return false" autocomplete="off"
                    class="form-control">
                </input>
            </div>

            <div t-att-class="'form-group col-lg-10' if bootstrap_formatting else 'form-group'">
                <input id="cardholderName" placeholder="Titular de la tarjeta" data-checkout="cardholderName" type="text" class="form-control"></input>
            </div>

            <!-- Identification -->
            <div t-att-class="'form-group col-lg-3' if bootstrap_formatting else 'form-group'">
                <select id="docType" name="docType" data-checkout="docType" type="text" class="form-control"></select>
            </div>

            <div t-att-class="'form-group col-lg-3' if bootstrap_formatting else 'form-group'">
                <input id="docNumber" name="docNumber" placeholder="NÃºmero" maxlength="16" data-checkout="docNumber" type="text" class="form-control"/>
            </div>

            <!-- Security code -->
            <div t-att-class="'form-group col-lg-3' if bootstrap_formatting else 'form-group'">
                <input id="cc_cvc" data-checkout="securityCode" type="text"
                placeholder="cvv"
                maxlength="4"
                onselectstart="return false" onpaste="return false"
                oncopy="return false" oncut="return false"
                ondrag="return false" ondrop="return false" autocomplete="off"
                class="form-control"></input>
            </div>

            <!-- Issuer -->
            <div id="issuerInput" t-att-class="'form-group col-lg-6' if bootstrap_formatting else 'form-control'">
                <select id="issuer" type="text" name="issuer" class="o_hidden form-control" data-checkout="issuer"></select>
            </div>

            <!-- Installments -->
            <div t-att-class="'form-group col-lg-8' if bootstrap_formatting else 'form-group'">
                <select type="text" id="installments" name="installments" class="o_hidden form-control" t-att-data-show-installments="'true' if mode == 'payment' and subscription != 'True' and amount else 'false'"></select>
            </div>

            <!-- Checkbox save card? -->
            <div t-if="mode == 'payment' and subscription != 'True'" t-att-class="'o_hidden' if request.website.is_public_user() else 'form-group col-lg-12'" >
                <input name = "save_token" type="checkbox" t-att-checked="not request.website.is_public_user()" id="save_token"/>
                <label for="save_token"> Save card? </label>
            </div>

            <!-- Extra fields -->
            <div>
                <input type="hidden" name="transactionAmount" id="transactionAmount" t-att-value="amount or None" />
                <input type="hidden" name="payment_method_id" id="paymentMethodId" />
                <input type="hidden" name="description" id="description" />
            </div>
        </div>
    </template>

    <record id="token_form_mercadopago" model="ir.ui.view">
        <field name='name'>payment.token.form</field>
        <field name='model'>payment.token</field>
        <field name="inherit_id" ref="payment.payment_token_form_view"/>
        <field name="arch" type="xml">
        <xpath expr='//field[@name="acquirer_ref"]' position='after'>
            <field name="email"/>
        </xpath>
        </field>
    </record>

    <template id="mercadopago_payment_tokens_list" name="MercadoPago Token List" inherit_id="payment.payment_tokens_list">

        <xpath expr="//div[hasclass('card-body')]/label/input[@name='pm_id']" position="attributes">
            <attribute name="t-att-data-acquirer-id">pm.acquirer_id.id</attribute>
            <attribute name="t-att-data-card_id"> pm.token </attribute>
            <attribute name="t-att-data-provider">pm.acquirer_id.provider</attribute>
            <t t-if="subscription == 'True'">
                <attribute name="t-att-data-subscription">subscription == 'True'</attribute>
            </t>
        </xpath>

        <xpath expr="//t[@t-if='pm.verified']" position="before">
            <t t-if="pm.acquirer_id.provider == 'mercadopago' and pm.email != request.env.user.email">
                <span> - </span>
                <span class="payment_option_name" t-esc="pm.email"/>
            </t>
        </xpath>

        <xpath expr="//button[@name='delete_pm']" position="after">
            <input t-if="mode == 'payment' and subscription != 'True' and pm.acquirer_id.provider == 'mercadopago'"
                t-attf-id="cc_cvc_{{pm.id}}"
                type="text"
                placeholder="cvv"
                maxlength="4"
                class="form-control col-lg-3"
                style="float: right"
                data-is-required="true"
                data-checkout="securityCode">
            </input>
        </xpath>
    </template>

    <template id="mercadopago_subscription" name="Subscription MercadoPago" inherit_id="sale_subscription.subscription">
        <!-- change pm form subscription: remove cvv field -->
        <xpath expr="//div[@id='payment_method']//t[@t-set='mode']" position="after">
            <t t-set="subscription" t-value="'True'"/>
        </xpath>
        <!-- closed subscription: remove cvv field -->
        <xpath expr="//div[hasclass('clearfix')]//t[@t-set='mode']" position="after">
            <!-- <t t-set="subscription" t-value="'True'"/> -->
        </xpath>
    </template>

    <template id="mercadopago_confirmation" inherit_id="website_sale.confirmation">
        <xpath expr="//t[@t-esc='order.get_portal_last_transaction().acquirer_id.name']" position="after">
            <t t-if="order.client_order_ref and order.get_portal_last_transaction().acquirer_id.provider == 'mercadopago'">
                <t t-esc="order.client_order_ref.replace('MercadoPago', '')"/>
            </t>
        </xpath>
        <xpath expr="//div[@id='oe_structure_website_sale_confirmation_2']" position="after">
            <t t-if="payment_tx_id.state == 'error'">
                <a role="button" href="/shop/payment" class="btn btn-secondary mb32 d-none d-xl-inline-block">
                    <span class="fa fa-chevron-left" />
                    <span class="">Return to Payment</span>
                </a>
            </t>
        </xpath>
    </template>

</odoo>

